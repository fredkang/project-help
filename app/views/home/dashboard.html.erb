
<!-- This container sets the size of of the topics sidebar -->
<div class="col-sm-3 dashboard-container" >
	<!-- Div contains the topics sidebar -->
	<div id="topics-sidebar" class="panel panel-default">
		
		<!-- Heading for the section -->
		<div class="panel-heading">
			<h2 class="panel-title"> Topics in your network </h2>
		</div>
		
		<!-- Body for the section -->
		<div class="panel-body">

			<!-- Form that user uses to search for a particular topic -->
			<form action='/topics/search' method='post' id='search-form'>
				<input name="utf8" type="hidden" value="âœ“">
				<input name="authenticity_token" type="hidden" value="0ajn97Rdg7axTJta0bP5Ts2XAf3xrgzrkDzWKU6oagQ=">
				
				<div class="form-group">
					<div class="input-group">
						<input class="form-control" type="text" placeholder="Search for a topic" name="search_term" id="topic-search-input">
						
						<span class="input-group-addon" id="topic-search-glyph">
							<a href="" id="search-submit">
								<span class="glyphicon glyphicon-search"></span>
							</a>

							<a href="" id="search-cancel">
								<span class="glyphicon glyphicon-remove-circle"></span>
							</a>
						</span>
					</div>
				</div>
			</form>

			<div id="topic-list">
				<p><b>
					<span id="featured-link">Featured</span> / 
					<span id="all-link"><a href="">All</a></span>
				</b></p>
				
				<p id="all-topics" class="topic-sub-list">
					<% @all_topics.each_with_index do |topic, i| %>
						<a href=""><%=topic.name%></a> 
						<% if i != @all_topics.length-1 %>
							&#8901 
						<% end %>
					<% end %>
				</p>

				<p id="featured-topics" class="topic-sub-list">
					<% @featured_topics.each_with_index do |topic, i| %>
						<a href=""><%=topic.name%></a> 
						<% if i != @featured_topics.length-1 %>
							&#8901 
						<% end %>
					<% end %>
				</p>
			</div>

			<div id="search-results" class="topic-sub-list">
			</div>
		</div>
	</div>
</div>

<!-- This container sets the size of the main Group/People section -->
<div class="col-sm-9 dashboard-container">
	<!-- Div contains the Group / People section -->
	<div id="groups-people-main" class="panel panel-default">
		
		<!-- Heading for the section -->
		<div class="panel-heading">
			<h2 class="panel-title">Groups / People in your network</h2>
		</div>
		
		<!-- The panel-body will be the section showing members -->
		<div id="members" class="panel-body">
		</div>

		<!-- The list group will contain the Group overviews -->
		<ul class="list-group">
			
			<% @groups.each_with_index do |group, i| %>
			
				<!-- Each Group will be shown in a list-group-item -->
				<li class="list-group-item dashboard-group-item">
					<div class="col-sm-12">
						<h4><%=group.name + " (" + @group_users[i].count.to_s + " people, " + @group_topics[i].count.to_s + " topics)"%></h4>
					</div>

					<div class="dashboard-group-posts col-sm-8">	
						<div class="panel panel-default">
							<div class="panel-body">
								<label>Post to Coding Dojo</label>
								<input class="form-control" placeholder="Ask a question or start a discussion with <%=group.name%>"></input>
							</div>
							
							<ul class="list-group">
								<li class="list-group-item">
									<b><p class="recent-posts-label">Recent Posts</p></b>
								
									<!-- Show the Posts -->
									<% @group_posts[i].each do |post| %>
										
										<!-- Store the author of this post into a variable, as we will need his user info later -->
										<% postAuthor = User.find(post.user_id) %>

										<!-- Calculate the time elapsed since this post was created and store it in the proper format to be printed out with the comment -->
										<% timediff = (Time.now - post.created_at).to_i %>
										
										<!-- Retreive all of the comments for this post -->
										<% comments = post.comments.all %>
										<% newcomment = post.comments.new %>
										
										<!-- Use format_time_diff from application helper to return the proper time stamp for comments -->
										<% timediffString = format_time_diff(timediff) %>	

										<div class="post-div">
											<p><strong><a href="/users/<%=postAuthor.id%>"><%= postAuthor.first_name + " " + postAuthor.last_name %></a></strong>   -   <span class="post-time"><%= timediffString %></span></p>
											<div class="post-text"><p class="post-text"><%= h auto_link(simple_format(post.text.gsub(/\r\n/, '<br />'))) %></p>
											</div>
										</div>
									<% end %>
								</li>
							</ul>
						</div>
					</div>

					<div class="dashboard-featured-members col-sm-4">
						<div class="panel panel-default">
							<div class="panel-body">
								Featured Members
							</div>
							
							<ul class="list-group">
								<% @group_helpers[i].each do |user| %>
									<li class="list-group-item">
										<div class="media">
											<div class="pull-left">
												<% if user.image.file.nil? || !user.image.thumb.file.exists? %>
													<img src = "http://placekitten.com/35/35" class="media-object">
												<% else %>
													<%= image_tag user.image_url(:tiny_thumb).to_s, class:"media-object" %>
												<% end %>
											</div>
											<div class="media-body">
												<p class="featured-user-name"><%=user.first_name + " " +user.last_name%></p>
												<p class="featured-user-role"><%=user.current%></p>
												<p class="featured-user-topics">
													Topics: blahblah
												</p>
											</div>
										</div>
									</li>
								<% end %>
							</ul>
						</div>
					</div>
					
					<div class="clearfix">
					</div>
				</li>
			<% end %>
			
			
			<!-- The last list-group-item will contain options to add or join groups -->
			<li class="list-group-item">
				<a class="btn btn-primary">Join Group</a>
				<a class="btn btn-success">Create Group</a>
			</li>
		</ul>
	</div>
</div>

<script>

	$("#search-cancel").hide();
	$("#search-results").hide();
	$("#all-topics").hide();

	$(document).ready(function() {

		// When user clicks on Featured topics link, hide the All topics div
		// and show the Featured topics div. Then change take away the link from 
		// Featured and add the link to All
		$(document).on("click", "#featured-link a", function() {
			$("#all-topics").hide();
			$("#featured-topics").show();
			
			$("#all-link").html("<a href=''>All</a>");
			$("#featured-link").html("Featured");

			return false;
		});

		// When user clicks on All topics link, hide the Featured topics div
		// and show the All topics div. Then change take away the link from 
		// All and add the link to Featured
		$(document).on("click", "#all-link a", function() {
			$("#featured-topics").hide();
			$("#all-topics").show();
			
			$("#featured-link").html("<a href=''>Featured</a>");
			$("#all-link").html("All");

			return false;
		});

		// Submit the search form when someone clicks the magnifying glass
		$("#search-submit").click(function() {
			$("#search-form").submit();

			return false;
		});


		// Submit the search form when some presses enter in the search field
		$("#topic-search-input").keypress(function(e) {
			if (e.which == 13)
			{
				$("#search-form").submit();
				
				return false;
			}
		});
		
		// When the search form is submited, perform a .post to home/dashboard
		// with the search_term. Then take the result and print it appropriately
		$("#search-form").on('submit', function() {
			var action = $("#search-form").attr('action');
			var content = $("#search-form").serialize();

			// Perform the post action to home/dashboard
			$.post(action, content, function(data){
				// matching_topics is the return result
				var matching_topics = data['results'];

				// term is the variable the HTML will be stored in to be written
				// into the empty div to display the search results
				var term = "";

				// If there are no results, print 'No topics added yet'
				if(matching_topics.length == 0)
				{
					term = term + "No topics added yet";
				}
				// If there are results, loop through them, making each one into a link
				else
				{
					for (var i=0; i<matching_topics.length; i++)
					{
						term = term + "<a href=''>" + matching_topics[i].name + "</a> "

						if(i != matching_topics.length-1)
						{
							term = term + "&#8901 "
						}
					}
				}

				// Write the results into the empty div for search results
				$("#search-results").html(term);
				
				// Turn the magnifying glass into a cancel button. Show the search results
				// hide the all / featured topics
				$("#search-results").show();
				$("#search-cancel").show();
				$("#search-submit").hide();
				$("#topic-list").hide();
			}, "json");

			return false;
		});

		// When the search is canceled, turn the cancel button into a magnifying glass, 
		// hide the search results and show the all / featured topics
		$("#search-cancel").click(function() {
			$("#search-submit").show();
			$("#search-cancel").hide();
			$("#search-results").html("");
			$("#search-results").hide();
			$("#topic-list").show();

			$("#topic-search-input").val("");

			return false;
		});
	});
</script>
